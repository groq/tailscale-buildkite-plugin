#!/bin/bash

set -euo pipefail

client_secret="${!BUILDKITE_PLUGIN_TAILSCALE_CLIENT_SECRET_ENV?"Client secret env must be set"}"
tags="${BUILDKITE_PLUGIN_TAILSCALE_TAGS?"Tags must be set"}"

hostname="${BUILDKITE_PLUGIN_TAILSCALE_HOSTNAME:-buildkite-${BUILDKITE_AGENT_NAME:-$(hostname)}}"
timeout="${BUILDKITE_PLUGIN_TAILSCALE_TIMEOUT:-120}"

nohup tailscaled --state=mem: < /dev/null > /var/log/tailscaled.log 2> /var/log/tailscaled.err.log &

echo "~~~ Waiting for Tailscale daemon to start..."
timeout "$timeout" /bin/bash -c "until tailscale status --json >/dev/null 2>&1; do sleep 1; done"
echo "‚úÖ Tailscale daemon started successfully"

echo "üåê Connecting to Tailscale network..."
authkey="${client_secret}?preauthorized=true&ephemeral=true"
tailscale up \
  --authkey="$authkey" \
  --hostname="$hostname" \
  --advertise-tags="$tags" \
  --accept-routes \
  --timeout "${timeout}s"

echo "‚úÖ Successfully connected to Tailscale!"

echo "üìä Connection status:"
tailscale status
